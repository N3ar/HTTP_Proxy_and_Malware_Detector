/*
 * proxy server that detects malware.
 *
 * built by YOU, as a capstone project for coursework pursued in CS5434
 * Defending Computer Networks.
 *
 */

#include <arpa/inet.h>
#include <clamav.h>
#include <stdint.h>
#include <stdio.h>
#include <sys/socket.h>
#include <unistd.h>
#include <zlib.h>
#define PROXY_PORT 8080
#define QUEUE_SIZE 15

// executive entrypoint
int main(int argc, char** argv) {

  // create a socket to listen on
  int s = socket(AF_INET, SOCK_STREAM, 0);
  if (s == -1) {
    printf("could not create socket. reason: %s\n", strerror(errno));
    return 1;
  }

  // setup socket options such that the port can be reused quickly after
  // program termination
  struct sockaddr_in local_sockaddr;
  local_sockaddr.sin_family = AF_INET;
  local_sockaddr.sin_addr.s_addr = htonl(INADDR_ANY);
  local_sockaddr.sin_port = htons(PROXY_PORT);
  int one = 1;
  if (setsockopt(s, SOL_SOCKET, SO_REUSEADDR, &one, sizeof(one)) == -1) {
    printf("could not set socket options. reason: %s\n", strerror(errno));
    return 1;
  }

  // bind socket to the sockaddr_in structure
  if (bind(s, (struct sockaddr*) &local_sockaddr,
    sizeof(local_sockaddr)) == -1) {
    printf("could not bind to socket. reason: %s\n", strerror(errno));
    return 1;
  }

  // set socket to listening mode
  if (listen(s, QUEUE_SIZE) == -1) {
    printf("could not listen on socket. reason: %s\n", strerror(errno));
  }

  while (1) {
    // wait for a TCP connection. the accept() function will block until the
    // TCP handshake is complete.
    struct sockaddr_in remote_sockaddr;
    socklen_t address_len = sizeof(remote_sockaddr);
    int client; // client socket

    client = accept(s, (struct sockaddr*) &remote_sockaddr, &address_len);
    if (client == -1) continue;

    // from here, you should use pthread_create() to setup a thread that will
    // handle this TCP connection. the original thread should loop and wait on
    // the accept() function in order to handle more concurrent threads.
    printf("connection accepted. socket id: %d\n", client);

    // TODO -- write some code. the last code you'll ever write for this class.
  }

  return 0;
}
