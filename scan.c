/*
 * a no-frills libclamav example, adapted by Z.Teo from:
 * http://garage-wayne.blogspot.com/2012/11/clamav-utilization-libclamav-api-example.html
 *
 * library documentation for libclamav can be found at:
 * http://www.clamav.net/documents/installing-clamav
 * click on the clamAV manual link.
 *
 */

#include <clamav.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

// executive entrypoint
int main(int argc, char **argv) {
  if (argc != 2) {
    printf("usage: %s file\n", argv[0]);
    return 1;
  }

  // init libclamav
  if (cl_init(CL_INIT_DEFAULT) != CL_SUCCESS) {
    printf("could not init clamAV.\n");
    return 1;
  }

  // load virus db and compile the av engine
  struct cl_engine* engine = cl_engine_new();
  const char* db_dir = cl_retdbdir();
  unsigned int signature_count = 0;
  printf("loading from database at %s\n", db_dir);
  if (cl_load(db_dir, engine, &signature_count, CL_DB_STDOPT) != CL_SUCCESS ||
    cl_engine_compile(engine) != CL_SUCCESS) {
    printf("failed to load db/compile AV engine.\n");
    return 1;
  }
  printf("%d virus signatures loaded.\n", signature_count);

  // perform the scan. if you need to scan multiple files, you do not need to
  // re-initialize/compile the scan engine. just keep calling cl_scanfile(), 
  // once for each new file you want to scan. the function should be
  // thread safe.
  const char* virus_name;
  int scan_result;
  long unsigned int scanned;  // unimportant. its use in cl_scanfile can be
                              // replaced with NULL. see manual for
                              // documentation.

  scan_result = cl_scanfile(argv[1], &virus_name, &scanned, engine,
    CL_SCAN_STDOPT);
  switch (scan_result) {
    case CL_VIRUS:
      printf("[X] found virus: [%s]\n", virus_name);
      break;
    case CL_CLEAN:
      printf("[O] clean.\n");
      break;
    default:  // should not get here
      break;
  }

  // all done
  return 0;
}
